<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../graphene-client/graphene-client.html">
<link rel="import" href="../graphene-doc/graphene-doc.html">
<link rel="import" href="../../conf/api-settings.html">

<dom-module id="graphene-crud">
    <template>
        <graphene-client id="client"></graphene-client>
        <graphene-doc id="create-doc"></graphene-doc>
        <graphene-doc id="read-doc"></graphene-doc>
        <graphene-doc id="update-doc"></graphene-doc>
        <graphene-doc id="delete-doc"></graphene-doc>
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'graphene-crud',
                attached: function () {
                    this._cDoc = this.$$('#create-doc');
                    this._rDoc = this.$$('#read-doc');
                    this._uDoc = this.$$('#update-doc');
                    this._dDoc = this.$$('#delete-doc');
                },

                create: function () {
                    if (!!this._cDoc && this.isValid('c'))
                        return this.$.client.gFetch(this.modelDoc.c, this.model);
                },

                read: function (id) {

                    if (!!this.modelDoc.r)
                        return this.$.client.gFetch(this.modelDoc.r.replace(':id', id));
                },

                update: function () {
                    if (!!this.modelDoc.r && this.isValid('u'))
                        return this.$.client.gFetch(this.modelDoc.u, this.model);
                },

                delete: function () {
                    if (!!this.modelDoc.d && this.isValid('d'))
                        return this.$.client.gFetch(this.modelDoc.d, this.model);
                },

                getCStruct: function () {
                    return this.a;
                },

                getRStruct: function () {

                },

                getUStruct: function () {

                },

                getDStruct: function () {

                },

                isValid: function (mode) {
                    return true;
                },


                _fetchDoc: function (action, mode) {
                    this.$.client.fetch('/system/doc/' + action.replace('.', '__'))
                            .then(function (res) {
                                this.modelDoc[mode] = res;
                            }.bind(this))
                            .catch(function (err) {
                                console.error('Cannot fetch doc of: ' + newModelName + ' error during download ', err)
                            }.bind(this));
                },

                _modelNameChanged: function (newModelName) {
                    this.modelName = newModelName;
                    if (!!apiSettings.actions[this.modelName] && apiSettings.actions[this.modelName].crud) {
                        this._cDoc.setActionName(apiSettings.actions[this.modelName].c);
                        this._rDoc.setActionName(apiSettings.actions[this.modelName].r);
                        this._uDoc.setActionName(apiSettings.actions[this.modelName].u);
                        this._dDoc.setActionName(apiSettings.actions[this.modelName].d);
                    } else {
                        console.error('crud of ' + this.modelName + ' is not handled check the api-settings.html file');
                    }
                },

                properties: {
                    modelName: {type: String, observer: '_modelNameChanged'}, //namespace-modelname
                    _cDoc: Object,
                    _rDoc: Object,
                    _uDoc: Object,
                    _dDoc: Object,
                    //Modello corrente
                    model: Object
                }
            });
        })();
    </script>
</dom-module>
