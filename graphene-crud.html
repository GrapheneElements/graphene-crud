<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<dom-module id="graphene-crud">
    <template>
        <graphene-client id="client"></graphene-client>
        <graphene-doc id="c" request-proto="{{createProto}}" action-name="{{cAction}}"
                      doc="{{_c0Doc}}"></graphene-doc>
        <graphene-doc id="r" response-proto="{{readProto}}" action-name="{{rAction}}"
                      doc="{{_r0Doc}}"></graphene-doc>
        <graphene-doc id="u" request-proto="{{updateProto}}" action-name="{{uAction}}"
                      doc="{{_u0Doc}}"></graphene-doc>
        <graphene-doc id="d" request-proto="{{deleteProto}}" action-name="{{dAction}}"
                      doc="{{_d0Doc}}"></graphene-doc>
    </template>
    <script>
        (function() {
            'use strict';
            Polymer({
                is: 'graphene-crud',

                create: function(model) {
                    return this.$.client.fetch(this._cDoc.url, model);
                },

                read: function(id) {
                    return this.$.client.fetch(this._rDoc.url.replace(':id', id));
                },

                update: function(model) {
                    return this.$.client.fetch(this._uDoc.url, model, this._uDoc.method);
                },

                delete: function(model) {
                    return this.$.client.fetch(this._dDoc.url, model, this._dDoc.method);
                },

                _getAction: function(settings, mode) {
                    return this.settings[mode];
                },

                _loadSettings: function(modelName) {
                    var modelSettings = window.graphene.settings.models[modelName];
                    if (!!modelSettings) {
                        return {
                            c: modelSettings + '_CREATE',
                            r: modelSettings + '_READ',
                            u: modelSettings + '_UPDATE',
                            d: modelSettings + '_DELETE'
                        };
                    } else {
                        return null;
                    }
                },

                _clearDoc: function(docInstance) {
                    var doc = docInstance.base.DocAction[0];
                    return doc;
                },

                _checkReady: function(_cDoc, _rDoc, _uDoc, _dDoc) {
                    if (!!_cDoc.base.url && !!_rDoc.base.url && !!_uDoc.base.url && !!_dDoc.base.url) {
                        this.fire('crud-ready');
                        return true;
                    }
                    return false;
                },


                observers: [],

                properties: {
                    modelName: String, //namespace-modelname

                    createProto: {type: Object, notify: true},
                    readProto:   {type: Object, notify: true},
                    updateProto: {type: Object, notify: true},
                    deleteProto: {type: Object, notify: true},

                    settings: {type: Object, computed: '_loadSettings(modelName)'},
                    cAction:  {type: String, computed: '_getAction(settings.*, \'c\' )'},
                    rAction:  {type: String, computed: '_getAction(settings.*, \'r\' )'},
                    uAction:  {type: String, computed: '_getAction(settings.*, \'u\' )'},
                    dAction:  {type: String, computed: '_getAction(settings.*, \'d\' )'},

                    isReady: {type: Boolean, computed: '_checkReady(_cDoc.*, _rDoc.*, _uDoc.*, _dDoc.*)'},

                    _cDoc: {type: Object, computed: '_clearDoc(_c0Doc.*)'},
                    _rDoc: {type: Object, computed: '_clearDoc(_r0Doc.*)'},
                    _uDoc: {type: Object, computed: '_clearDoc(_u0Doc.*)'},
                    _dDoc: {type: Object, computed: '_clearDoc(_d0Doc.*)'},

                    _c0Doc: Object,
                    _r0Doc: Object,
                    _u0Doc: Object,
                    _d0Doc: Object
                }
            });
        })();
    </script>
</dom-module>
